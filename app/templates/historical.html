{% extends 'base.html' %}

{% block content %}
  <style>
    .chart-container {
      height: 640px;
      min-height: 60vh;
    }

    @media (max-width: 576px) {
      .chart-container {
        height: 70vh;
      }
    }
  </style>
  <h2>Investment Universe &ndash; Benchmark Composition</h2>
  <p class="lead">Select the assets that form your investment universe. This will serve as the basis for your benchmark portfolio and downstream performance comparisons.</p>
  <p class="text-muted">The tool relies on Fama-French daily industry portfolios for long, academically vetted history. Log returns keep compounding consistent and avoid downstream math surprises. Choose the industry granularity and weighting that best mirrors your investment approach, then view how that benchmark would have evolved over time.</p>

  <form method="post" class="row gy-3 gx-3 align-items-end mb-4">
    <div class="col-md-4">
      <label class="form-label" for="universe">Industry Universe (benchmark building blocks)</label>
      <select class="form-select" id="universe" name="universe">
        {% for u in universes %}
          <option value="{{ u }}" {% if u|string == selected_universe %}selected{% endif %}>{{ u }} Industries</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Weighting Scheme</label>
      <div class="d-flex gap-3">
        <div class="form-check">
          <input class="form-check-input" type="radio" id="weight_value" name="weighting" value="value" {% if weighting == 'value' %}checked{% endif %}>
          <label class="form-check-label" for="weight_value">Value-weighted benchmark</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="weight_equal" name="weighting" value="equal" {% if weighting == 'equal' %}checked{% endif %}>
          <label class="form-check-label" for="weight_equal">Equal-weighted benchmark</label>
        </div>
      </div>
    </div>
    <div class="col-12">
      <label class="form-label" for="start_date">Start Date for benchmark window</label>
      <input class="form-control" id="start_date" name="start_date" type="date" value="{{ start_date_value }}">
    </div>
    <div class="col-12">
      <label class="form-label" for="end_date">End Date for benchmark window</label>
      <input class="form-control" id="end_date" name="end_date" type="date" value="{{ end_date_value }}">
    </div>
    <div class="col-12 d-flex flex-column flex-sm-row gap-2 align-items-start align-items-sm-center">
      <button class="btn btn-primary" type="submit">Refresh benchmark view</button>
      <p class="text-muted small mb-0">Defaults show the past 50 years ending today for the 5-industry portfolios using log returns.</p>
    </div>
  </form>

  {% if chart_data %}
    <div class="card shadow-sm mb-3">
      <div class="card-body p-4 p-lg-5">
        <h5 class="card-title">Benchmark growth from investment universe (Index = 100)</h5>
        <p class="card-subtitle text-muted small mb-3">Historical performance of the selected universe; this shapes the benchmark you will compare future portfolios against. Long histories are resampled monthly for a faster, smoother view.</p>
        <div id="industryChart" class="chart-container"></div>
      </div>
    </div>
    <script src="https://cdn.plot.ly/plotly-2.35.0.min.js" crossorigin="anonymous"></script>
    <script>
      const chartData = {{ chart_data | tojson }};
      const palette = ['#2563eb', '#16a34a', '#ea580c', '#9333ea', '#0f172a', '#e11d48', '#0284c7', '#a855f7'];

      const traces = chartData.series.map((series, idx) => ({
        type: 'scatter',
        mode: 'lines',
        name: series.name,
        x: series.x,
        y: series.y,
        line: { color: palette[idx % palette.length], width: 2, shape: 'spline', smoothing: 0.2 },
        hoverinfo: 'x+y+name',
        hovertemplate: '%{x}<br>%{y:.2f}' + '<extra>' + series.name + '</extra>',
      }));

      const layout = {
        margin: { t: 40, r: 20, b: 60, l: 60 },
        xaxis: {
          title: 'Date',
          rangeslider: { visible: true },
          tickformat: '%b %Y',
          automargin: true,
        },
        yaxis: {
          title: 'Benchmark index level',
          tickformat: ',.0f',
          automargin: true,
        },
        legend: { orientation: 'h', y: -0.2 },
        hovermode: 'closest',
        template: 'plotly_white',
      };

      const chartContainer = document.getElementById('industryChart');
      Plotly.purge(chartContainer);
      Plotly.newPlot(chartContainer, traces, layout, { displaylogo: false, responsive: true });
    </script>
  {% else %}
    <p class="text-muted">No chart data available for the selected configuration.</p>
  {% endif %}
{% endblock %}
