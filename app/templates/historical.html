{% extends 'base.html' %}

{% block content %}
  <style>
    .chart-container {
      height: 640px;
      min-height: 60vh;
    }

    @media (max-width: 576px) {
      .chart-container {
        height: 70vh;
      }
    }
  </style>
  <h2>Investment Universe &ndash; Benchmark Composition</h2>
  <p class="lead">Select the assets that form your investment universe. This will serve as the basis for your benchmark portfolio and downstream performance comparisons.</p>
  <p class="text-muted">The tool relies on Fama-French daily industry portfolios for long, academically vetted history. Log returns keep compounding consistent and avoid downstream math surprises. Choose the industry granularity, then view how that benchmark would have evolved over time. Benchmarks are value-weighted; you can optionally view the log of price growth to better spot long-run compounding.</p>

  <form method="post" class="row gy-3 gx-3 align-items-end mb-4">
    <div class="col-md-4">
      <label class="form-label" for="universe">Industry Universe (benchmark building blocks)</label>
      <select class="form-select" id="universe" name="universe">
        {% for u in universes %}
          <option value="{{ u }}" {% if u|string == selected_universe %}selected{% endif %}>{{ u }} Industries</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label" for="transform">Growth display</label>
      <select class="form-select" id="transform" name="transform">
        <option value="index" {% if transform == 'index' %}selected{% endif %}>Indexed price growth (base = 100)</option>
        <option value="log" {% if transform == 'log' %}selected{% endif %}>Log price growth</option>
      </select>
    </div>
    <div class="col-12">
      <label class="form-label" for="start_date">Start Date for benchmark window</label>
      <input class="form-control" id="start_date" name="start_date" type="date" value="{{ start_date_value }}">
      <p class="form-text">Defaults to the earliest available Fama-French daily industry data.</p>
    </div>
    <div class="col-12 d-flex flex-column flex-sm-row gap-2 align-items-start align-items-sm-center">
      <button class="btn btn-primary" type="submit">Refresh benchmark view</button>
      <p class="text-muted small mb-0">Defaults show the full available history ending today for the 5-industry portfolios using log returns.</p>
    </div>
  </form>

  {% if chart_data %}
    <div class="card shadow-sm mb-3">
      <div class="card-body p-4 p-lg-5">
        <h5 class="card-title">Benchmark growth from investment universe</h5>
        <p class="card-subtitle text-muted small mb-3">Historical performance of the selected universe; this shapes the benchmark you will compare future portfolios against. Long histories are resampled monthly for a faster, smoother view. Use the dropdown to switch between indexed price levels and log price growth.</p>
        <div id="industryChart" class="chart-container"></div>
      </div>
    </div>
    <script src="https://cdn.plot.ly/plotly-2.35.0.min.js" crossorigin="anonymous"></script>
    <script>
      const chartData = {{ chart_data | tojson }};
      const traces = chartData.series.map((series) => ({
        type: 'scatter',
        mode: 'lines',
        name: series.name,
        x: series.x,
        y: series.y,
        line: {
          color: series.name === 'Benchmark' ? '#dc2626' : '#9ca3af',
          width: series.name === 'Benchmark' ? 3 : 2,
          shape: 'spline',
          smoothing: 0.2,
        },
        hoverinfo: 'name',
        hovertemplate: '<b>%{fullData.name}</b><extra></extra>',
      }));

      const layout = {
        margin: { t: 40, r: 20, b: 60, l: 60 },
        xaxis: {
          title: 'Date',
          rangeslider: { visible: true },
          tickformat: '%b %Y',
          automargin: true,
        },
        yaxis: {
          title: chartData.y_axis_title || 'Benchmark index level',
          tickformat: chartData.y_axis_title && chartData.y_axis_title.toLowerCase().includes('log') ? '.2f' : ',.0f',
          automargin: true,
        },
        legend: { orientation: 'h', y: -0.2, title: { text: '' } },
        hovermode: 'closest',
        template: 'plotly_white',
      };

      const chartContainer = document.getElementById('industryChart');
      Plotly.purge(chartContainer);
      Plotly.newPlot(chartContainer, traces, layout, { displaylogo: false, responsive: true });
    </script>
  {% else %}
    <p class="text-muted">No chart data available for the selected configuration.</p>
  {% endif %}
{% endblock %}
